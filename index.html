<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>الحاسبة العمالية – كفاءات عبدالعزيز</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background-color: #f7f9fb;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .app-header {
            background: linear-gradient(135deg, #187860, #0f4f43);
            color: #fff;
            padding: 1rem 0;
        }
        .brand-title {
            font-size: 1.6rem;
            font-weight: 700;
        }
        .brand-subtitle {
            font-size: .9rem;
            opacity: .85;
        }
        .card {
            border-radius: 1rem;
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,.06);
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            border-right: 4px solid #187860;
            padding-right: .5rem;
            margin-bottom: 1rem;
        }
        .result-box {
            background-color: #d8ca89;
            border-radius: .75rem;
            padding: .75rem 1rem;
            font-weight: 600;
        }
        .result-label {
            color: #444;
            font-size: .9rem;
        }
        .result-value {
            font-weight: 700;
        }
        .toolbar-btn {
            border-radius: 999px;
        }
        .logo-vision {
            max-height: 50px;
        }
        @media print {
            /* إخفاء كل شيء ما عدا التقرير عند الطباعة من نافذة التقرير */
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- رأس الصفحة -->
    <header class="app-header mb-4">
        <div class="container d-flex align-items-center justify-content-between">
            <div>
                <div class="brand-title">الحاسبة العمالية</div>
                <div class="brand-subtitle">شركة كفاءات عبدالعزيز – أداة تقديرية لحساب الحقوق العمالية</div>
            </div>
            <div class="d-flex align-items-center gap-3">
                <!-- لو حاب تضيف شعارات لاحقًا حط صور هنا -->
                <!-- <img src="images/vision2030.png" alt="رؤية 2030" class="logo-vision"> -->
                <!-- <img src="images/kafaat-logo.png" alt="كفاءات عبدالعزيز" class="logo-vision"> -->
            </div>
        </div>
    </header>

    <main class="container mb-5">
        <!-- بطاقة الحاسبة -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title mb-0">بيانات الحساب</h2>
                    <span class="badge bg-warning text-dark">
                        أداة تقديرية – النتائج تقريبية وقد تختلف بحسب تفاصيل كل حالة
                    </span>
                </div>

                <!-- بيانات أساسية -->
                <div class="row g-3 mb-3">
                    <div class="col-md-4 col-12">
                        <label class="form-label">اسم الموظف</label>
                        <input type="text" id="employeeName" class="form-control" placeholder="اكتب اسم الموظف">
                    </div>
                    <div class="col-md-4 col-12">
                        <label class="form-label">اسم جهة العمل</label>
                        <input type="text" id="employerName" class="form-control" placeholder="اكتب اسم جهة العمل">
                    </div>
                    <div class="col-md-4 col-12">
                        <label class="form-label">نوع الموظف</label>
                        <select id="employeeType" class="form-select">
                            <option value="saudi">سعودي</option>
                            <option value="non-saudi">غير سعودي</option>
                        </select>
                    </div>
                </div>

                <!-- الرواتب -->
                <div class="row g-3 mb-3">
                    <div class="col-md-3 col-12">
                        <label class="form-label">الأجر الأساسي (شهرياً)</label>
                        <input type="number" id="basicSalary" class="form-control" min="0" step="0.01" placeholder="مثال: 5000">
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">البدلات (شهرياً)</label>
                        <input type="number" id="allowances" class="form-control" min="0" step="0.01" placeholder="مثال: 1500">
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">الأجر بعد حسم التأمينات</label>
                        <input type="number" id="netSalary" class="form-control" min="0" step="0.01" placeholder="صافي الأجر">
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">إجمالي الأجر الشهري (يُحسب آلياً)</label>
                        <input type="number" id="totalSalary" class="form-control" readonly>
                    </div>
                </div>

                <!-- مدة الخدمة وباقي المدخلات -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-12">
                        <label class="form-label">مدة الخدمة (بالسنوات)</label>
                        <input type="number" id="yearsOfService" class="form-control" min="0" step="0.1" placeholder="مثال: 4.5">
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">الأجور المتأخرة (عدد الأشهر)</label>
                        <input type="number" id="delayedMonths" class="form-control" min="0" step="0.1" placeholder="مثال: 2">
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">أيام الإجازة المستحقة</label>
                        <input type="number" id="vacationDays" class="form-control" min="0" step="1" placeholder="مثال: 10">
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">ساعات العمل الإضافي</label>
                        <input type="number" id="overtimeHours" class="form-control" min="0" step="0.5" placeholder="مثال: 5">
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-12">
                        <label class="form-label">أيام الغياب</label>
                        <input type="number" id="absenceDays" class="form-control" min="0" step="1" placeholder="مثال: 1">
                    </div>
                </div>

                <!-- أزرار التحكم -->
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button class="btn btn-success toolbar-btn" type="button" onclick="calculateAndSave()">
                        <i class="bi bi-calculator"></i> احسب واحفظ العملية
                    </button>
                    <button class="btn btn-outline-secondary toolbar-btn" type="button" onclick="resetForm()">
                        <i class="bi bi-arrow-counterclockwise"></i> تصفية الحقول
                    </button>
                </div>

                <!-- النتائج الحالية -->
                <h3 class="section-title mt-3">النتائج الحالية</h3>
                <div class="result-box mb-2">
                    <div class="row gy-2">
                        <div class="col-md-4 col-12">
                            <div class="result-label">مكافأة نهاية الخدمة (مادة 84 – احتساب تقريبي):</div>
                            <div class="result-value" id="eosResult">0</div>
                        </div>
                        <div class="col-md-4 col-12">
                            <div class="result-label">الأجور المتأخرة:</div>
                            <div class="result-value" id="lateWagesResult">0</div>
                        </div>
                        <div class="col-md-4 col-12">
                            <div class="result-label">أجر الإجازة:</div>
                            <div class="result-value" id="vacationResult">0</div>
                        </div>
                        <div class="col-md-4 col-12">
                            <div class="result-label">أجر العمل الإضافي:</div>
                            <div class="result-value" id="overtimeResult">0</div>
                        </div>
                        <div class="col-md-4 col-12">
                            <div class="result-label">مبلغ الحسم بسبب الغياب:</div>
                            <div class="result-value" id="absenceResult">0</div>
                        </div>
                        <div class="col-md-4 col-12">
                            <div class="result-label">إجمالي الأجر الشهري:</div>
                            <div class="result-value" id="totalSalaryResult">0</div>
                        </div>
                    </div>
                </div>
                <small class="text-muted">
                    * هذه النتائج تقريبية لغرض التقدير فقط، ولا تُعد مرجعاً قانونياً نهائياً.
                </small>
            </div>
        </div>

        <!-- سجل العمليات -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title mb-0">سجل العمليات (محفوظ في هذا المتصفح)</h2>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-danger toolbar-btn" type="button" onclick="clearHistory()">
                            <i class="bi bi-trash"></i> مسح السجل بالكامل
                        </button>
                        <button class="btn btn-outline-primary toolbar-btn" type="button" onclick="printReport()">
                            <i class="bi bi-filetype-pdf"></i> تصدير تقرير PDF
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-striped align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>اسم الموظف</th>
                                <th>جهة العمل</th>
                                <th>إجمالي الأجر</th>
                                <th>مكافأة نهاية الخدمة</th>
                                <th>الأجور المتأخرة</th>
                                <th>أجر الإجازة</th>
                                <th>أجر الإضافي</th>
                                <th>حسم الغياب</th>
                                <th>تاريخ الحساب</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <!-- يتم تعبئته من JavaScript -->
                        </tbody>
                    </table>
                </div>
                <small class="text-muted">
                    ملاحظة: السجل محفوظ في المتصفح الحالي فقط (localStorage). إذا تم مسح بيانات المتصفح أو استخدام جهاز آخر فلن تظهر هذه العمليات.
                </small>
            </div>
        </div>
    </main>

    <!-- فوتر بسيط -->
    <footer class="py-3 mt-4 border-top text-center text-muted">
        عبدالعزيز – جميع الحقوق محفوظة © 2025
    </footer>

    <script>
        const STORAGE_KEY = 'kafaat_labor_calculations_v1';

        function parseNumber(value) {
            const n = parseFloat(value);
            return isNaN(n) ? 0 : n;
        }

        function calculateAll() {
            const basicSalary = parseNumber(document.getElementById('basicSalary').value);
            const allowances = parseNumber(document.getElementById('allowances').value);
            const netSalary = parseNumber(document.getElementById('netSalary').value || (basicSalary + allowances));
            const yearsOfService = parseNumber(document.getElementById('yearsOfService').value);
            const delayedMonths = parseNumber(document.getElementById('delayedMonths').value);
            const vacationDays = parseNumber(document.getElementById('vacationDays').value);
            const overtimeHours = parseNumber(document.getElementById('overtimeHours').value);
            const absenceDays = parseNumber(document.getElementById('absenceDays').value);

            // إجمالي الأجر الشهري
            const totalSalary = basicSalary + allowances;
            document.getElementById('totalSalary').value = totalSalary.toFixed(2);
            document.getElementById('totalSalaryResult').innerText = totalSalary.toFixed(2);

            // مكافأة نهاية الخدمة (احتساب تقريبي حسب مادة 84)
            // نصف أجر شهري عن كل سنة في الخمس الأولى، ثم أجر كامل عن كل سنة بعدها
            let eos = 0;
            if (yearsOfService > 0) {
                const firstFive = Math.min(yearsOfService, 5);
                const extraYears = Math.max(yearsOfService - 5, 0);
                eos = (netSalary / 2) * firstFive + (netSalary * extraYears);
            }
            document.getElementById('eosResult').innerText = eos.toFixed(2);

            // الأجور المتأخرة = إجمالي الأجر الشهري * عدد الأشهر
            const lateWages = totalSalary * delayedMonths;
            document.getElementById('lateWagesResult').innerText = lateWages.toFixed(2);

            // أجر الإجازة = أجر اليوم (من صافي الأجر أو الإجمالي) * عدد الأيام
            const dailySalary = netSalary > 0 ? netSalary / 30 : totalSalary / 30;
            const vacationPay = dailySalary * vacationDays;
            document.getElementById('vacationResult').innerText = vacationPay.toFixed(2);

            // أجر العمل الإضافي = أجر الساعة × عدد الساعات × 1.5
            const hourlySalary = dailySalary / 8; // نفترض 8 ساعات عمل في اليوم
            const overtimePay = hourlySalary * overtimeHours * 1.5;
            document.getElementById('overtimeResult').innerText = overtimePay.toFixed(2);

            // الحسم بسبب الغياب = أجر اليوم × أيام الغياب
            const absenceDeduction = dailySalary * absenceDays;
            document.getElementById('absenceResult').innerText = absenceDeduction.toFixed(2);

            return {
                basicSalary,
                allowances,
                netSalary,
                yearsOfService,
                delayedMonths,
                vacationDays,
                overtimeHours,
                absenceDays,
                totalSalary,
                eos,
                lateWages,
                vacationPay,
                overtimePay,
                absenceDeduction
            };
        }

        function getHistory() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY) || '[]';
                return JSON.parse(raw);
            } catch {
                return [];
            }
        }

        function setHistory(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function saveCalculation() {
            const employeeName = document.getElementById('employeeName').value.trim() || 'موظف غير مسمّى';
            const employerName = document.getElementById('employerName').value.trim() || 'جهة غير محددة';

            const calc = calculateAll(); // نحسب القيم ثم نحفظ

            const history = getHistory();
            history.push({
                employeeName,
                employerName,
                totalSalary: calc.totalSalary,
                eos: calc.eos,
                lateWages: calc.lateWages,
                vacationPay: calc.vacationPay,
                overtimePay: calc.overtimePay,
                absenceDeduction: calc.absenceDeduction,
                createdAt: new Date().toISOString()
            });

            setHistory(history);
            renderHistory();
        }

        function calculateAndSave() {
            calculateAll();
            saveCalculation();
        }

        function renderHistory() {
            const history = getHistory();
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            if (history.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 10;
                td.className = 'text-muted';
                td.innerText = 'لا توجد عمليات مسجلة حتى الآن.';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            history.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.employeeName}</td>
                    <td>${item.employerName}</td>
                    <td>${item.totalSalary.toFixed(2)}</td>
                    <td>${item.eos.toFixed(2)}</td>
                    <td>${item.lateWages.toFixed(2)}</td>
                    <td>${item.vacationPay.toFixed(2)}</td>
                    <td>${item.overtimePay.toFixed(2)}</td>
                    <td>${item.absenceDeduction.toFixed(2)}</td>
                    <td>${new Date(item.createdAt).toLocaleString('ar-SA')}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function clearHistory() {
            if (!confirm('هل أنت متأكد من مسح جميع العمليات المسجلة؟ لا يمكن التراجع بعد الحذف.')) return;
            localStorage.removeItem(STORAGE_KEY);
            renderHistory();
        }

        function resetForm() {
            document.getElementById('employeeName').value = '';
            document.getElementById('employerName').value = '';
            document.getElementById('employeeType').value = 'saudi';
            document.getElementById('basicSalary').value = '';
            document.getElementById('allowances').value = '';
            document.getElementById('netSalary').value = '';
            document.getElementById('totalSalary').value = '';
            document.getElementById('yearsOfService').value = '';
            document.getElementById('delayedMonths').value = '';
            document.getElementById('vacationDays').value = '';
            document.getElementById('overtimeHours').value = '';
            document.getElementById('absenceDays').value = '';

            document.getElementById('eosResult').innerText = '0';
            document.getElementById('lateWagesResult').innerText = '0';
            document.getElementById('vacationResult').innerText = '0';
            document.getElementById('overtimeResult').innerText = '0';
            document.getElementById('absenceResult').innerText = '0';
            document.getElementById('totalSalaryResult').innerText = '0';
        }

        function printReport() {
            const history = getHistory();
            const win = window.open('', '_blank');
            const now = new Date();

            let rows = '';
            if (history.length === 0) {
                rows = `
                    <tr>
                        <td colspan="10" style="text-align:center;color:#666;">
                            لا توجد عمليات مسجلة في هذا التقرير.
                        </td>
                    </tr>
                `;
            } else {
                history.forEach((item, index) => {
                    rows += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.employeeName}</td>
                            <td>${item.employerName}</td>
                            <td>${item.totalSalary.toFixed(2)}</td>
                            <td>${item.eos.toFixed(2)}</td>
                            <td>${item.lateWages.toFixed(2)}</td>
                            <td>${item.vacationPay.toFixed(2)}</td>
                            <td>${item.overtimePay.toFixed(2)}</td>
                            <td>${item.absenceDeduction.toFixed(2)}</td>
                            <td>${new Date(item.createdAt).toLocaleString('ar-SA')}</td>
                        </tr>
                    `;
                });
            }

            const html = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>تقرير الحاسبة العمالية – كفاءات عبدالعزيز</title>
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 20px; }
        h1, h2 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #999; padding: 6px; font-size: 12px; text-align: center; }
        th { background-color: #f1f1f1; }
        .meta { margin-top: 10px; font-size: 12px; }
        .footer { margin-top: 20px; text-align: center; font-size: 11px; color: #666; }
    </style>
</head>
<body>
    <h1>تقرير العمليات – الحاسبة العمالية</h1>
    <h2>شركة كفاءات عبدالعزيز</h2>
    <div class="meta">
        تم توليد التقرير في: ${now.toLocaleString('ar-SA')}
    </div>
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>اسم الموظف</th>
                <th>جهة العمل</th>
                <th>إجمالي الأجر</th>
                <th>مكافأة نهاية الخدمة</th>
                <th>الأجور المتأخرة</th>
                <th>أجر الإجازة</th>
                <th>أجر الإضافي</th>
                <th>حسم الغياب</th>
                <th>تاريخ الحساب</th>
            </tr>
        </thead>
        <tbody>
            ${rows}
        </tbody>
    </table>
    <div class="footer">
        هذا التقرير تقديري لأغراض إدارية فقط، ولا يُعد مستنداً قانونياً ملزماً.<br>
        عبدالعزيز – جميع الحقوق محفوظة © 2025
    </div>
    <script>
        window.print();
    </script>
</body>
</html>
`;
            win.document.open();
            win.document.write(html);
            win.document.close();
        }

        document.addEventListener('DOMContentLoaded', renderHistory);
    </script>
</body>
</html>